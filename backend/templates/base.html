<!doctype html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">
<style>
    /* Styles for the side-by-side layout */
    .results-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        margin-top: 20px;
    }

    /* On smaller screens, stack vertically */
    @media (max-width: 768px) {
        .results-container {
            flex-direction: column;
        }
    }

    .song-results-column,
    .places-column {
        flex: 1;
    }

    /* Places section styling with orange border */
    #places-section {
        background-color: transparent;
        padding: 15px;
        border-radius: 15px;
        border: 2px solid #FF9800;
        /* Orange border */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        /* Removed height: 100% to let it size naturally */
    }

    /* Places section title */
    #places-section h3 {
        font-family: 'Pacifico', cursive;
        color: #FF9800;
        /* Match the border color */
        margin-top: 0;
        margin-bottom: 15px;
        text-align: center;
    }

    /* Individual place items */
    .place-item {
        background-color: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Place name */
    .place-name {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }

    /* Star ratings */
    .star-rating {
        color: #FF9800;
        /* Orange stars */
        letter-spacing: 2px;
        font-size: 18px;
    }
</style>

<body>
    <div class="full-body-container">
        <div class="top-text">
            <h1 id="wandering-melody">ðŸŽ¶ WanderingMelody</h1>
            <p>Describe your mood or trip experience and get music recommendations!</p>

            <!-- Mood input -->
            <div class="input-box">
                <textarea placeholder="Describe your mood or trip experience" id="mood"></textarea>
            </div>

            <!-- Location input -->
            <div class="input-box">
                <input type="text" placeholder="Search Location (Optional)" id="location">
            </div>

            <!-- Age input -->
            <div class="input-box">
                <input type="number" placeholder="Enter Age (Optional)" id="age" min="1" max="100" value="18">
            </div>

            <!-- Genre input -->
            <div class="input-box">
                <input type="text" placeholder="Enter Music Genre" id="genre">
            </div>

            <!-- Weather dropdown -->
            <div class="input-box">
                <label for="weather"></label>
                <select class="styled-input" id="weather" name="weather">
                    <option value="">Select Weather</option>
                    <option value="sunny">Sunny</option>
                    <option value="cloudy">Cloudy</option>
                    <option value="rainy">Rainy</option>
                    <option value="stormy">Stormy</option>
                    <option value="snowy">Snowy</option>
                    <option value="foggy">Foggy</option>
                    <option value="windy">Windy</option>
                </select>
            </div>

            <button onclick="searchRecommendations()">Search</button>
        </div>

        <!-- Container for side-by-side layout -->
        <div class="results-container">
            <!-- Song results column -->
            <div class="song-results-column">
                <div id="answer-box"></div>
                <div id="loading-message" style="display:none;">Loading recommendations...</div>
            </div>

            <!-- Places column -->
            <div class="places-column" id="places-column" style="display:none;">
                <div id="places-section">
                    <h3>Places to Visit!</h3>
                    <div id="places-box"></div>
                    <div id="places-loading" style="display:none; text-align: center; padding: 10px;">
                        Searching for the most popular places to visit:
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function searchRecommendations() {
            console.log("Function searchRecommendations() was called!");
            const mood = document.getElementById("mood").value;
            const location = document.getElementById("location").value.trim();
            const age = document.getElementById("age").value;
            const genre = document.getElementById("genre").value;
            const weather = document.getElementById("weather").value;

            console.log("Search initiated with parameters:", { mood, location, age, genre, weather });

            const answerBox = document.getElementById("answer-box");
            answerBox.innerHTML = "";

            const loadingMessage = document.getElementById("loading-message");
            loadingMessage.style.display = "block";

            // Hide places column by default
            document.getElementById("places-column").style.display = "none";

            if (!mood && !genre) {
                alert("Please provide at least a mood description or a genre.");
                loadingMessage.style.display = "none";
                console.log("Input validation failed: Both mood and genre are missing.");
                return;
            }

            const requestUrl = "/recommendations?" + new URLSearchParams({
                mood: mood,
                location: location,
                age: age,
                genre: genre,
                weather: weather
            }).toString();

            console.log("Fetching recommendations from:", requestUrl);

            fetch(requestUrl)
                .then(response => {
                    console.log("Response received:", response);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Parsed response data:", data);
                    loadingMessage.style.display = "none";

                    if (data && data.length > 0) {
                        data.forEach(song => {
                            let songDiv = document.createElement("div");
                            songDiv.classList.add("song-box");
                            songDiv.innerHTML = `
                                <div class="song-details">
                                    <h3 class="song-title">${song.title}</h3>
                                    <p class="song-artist">by ${song.artist}</p>
                                    <p class="song-album">Album: ${song.album} | Genre: ${song.genre}</p>
                                    <p class="song-rating">Rating: ${song.rating || 'Not available'}</p>
                                </div>
                            `;
                            answerBox.appendChild(songDiv);
                        });

                        // Only fetch places if location is provided
                        if (location) {
                            fetchPlaces(location);
                        }
                    } else {
                        console.log("No songs found.");
                        answerBox.innerHTML = "<p>No songs found, try another genre or mood.</p>";

                        // Still fetch places even if no songs are found, but only if location is provided
                        if (location) {
                            fetchPlaces(location);
                        }
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    loadingMessage.style.display = "none";
                    alert("Error fetching recommendations. Please try again.");

                    // Try to fetch places even if song recommendations fail, but only if location is provided
                    if (location) {
                        fetchPlaces(location);
                    }
                });
        }

        // Function to generate star rating HTML
        function generateStarRating(rating) {
            if (!rating) return '<span class="star-rating">â˜†â˜†â˜†â˜†â˜†</span>';

            // Round to nearest half
            const roundedRating = Math.round(rating * 2) / 2;
            let stars = '';

            // Add full stars
            for (let i = 1; i <= Math.floor(roundedRating); i++) {
                stars += 'â˜…';
            }

            // Add half star if needed
            if (roundedRating % 1 !== 0) {
                stars += 'â¯ª';
            }

            // Add empty stars
            const emptyStars = 5 - Math.ceil(roundedRating);
            for (let i = 1; i <= emptyStars; i++) {
                stars += 'â˜†';
            }

            return `<span class="star-rating">${stars}</span>`;
        }

        // Separate function to fetch places
        function fetchPlaces(location) {
            // Only proceed if location is not empty
            if (!location || location.trim() === "") {
                return;
            }

            // Show places column and loading indicator
            document.getElementById("places-column").style.display = "block";
            document.getElementById("places-loading").style.display = "block";
            document.getElementById("places-box").innerHTML = "";

            console.log("Fetching places for:", location);

            // Fetch places
            fetch(`/get_places?location=${encodeURIComponent(location)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(places => {
                    console.log("Places data received:", places);
                    document.getElementById("places-loading").style.display = "none";

                    if (places && places.length > 0) {
                        let placesHtml = "";
                        places.forEach((place, index) => {
                            // Generate star rating
                            const starRating = generateStarRating(place.rating);

                            placesHtml += `
                                <div class="place-item">
                                    <p class="place-name">${index + 1}. ${place.name}</p>
                                    <p>${starRating} (${place.rating || 'N/A'})</p>
                                    ${place.reviews ? `<p>Reviews: ${place.reviews}</p>` : ''}
                                    ${place.category ? `<p>Category: ${place.category}</p>` : ''}
                                    ${place.address ? `<p>Address: ${place.address}</p>` : ''}
                                </div>
                            `;
                        });
                        document.getElementById("places-box").innerHTML = placesHtml;
                    } else {
                        // If no places found, hide the places column
                        document.getElementById("places-column").style.display = "none";
                    }
                })
                .catch(error => {
                    console.error("Error fetching places:", error);
                    document.getElementById("places-loading").style.display = "none";
                    // Hide places column on error
                    document.getElementById("places-column").style.display = "none";
                });
        }
    </script>
</body>