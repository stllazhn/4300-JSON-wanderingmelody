<!doctype html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">

<body>
    <div class="full-body-container">
        <div class="top-text">
            <h1 id="wandering-melody">üé∂ WanderingMelody</h1>
            <p>Describe your mood or trip experience and get music recommendations!</p>

            <!-- Mood input -->
            <div class="input-box">
                <textarea placeholder="Describe your mood or trip experience" id="mood"></textarea>
            </div>

            <!-- Country dropdown -->
            <div class="input-box">
                <label for="country"></label>
                <select class="styled-input" id="country" name="country">
                    <option value="">Select Country (Optional)</option>
                    <option value="Austria">Austria</option>
                    <option value="Canada">Canada</option>
                    <option value="China">China</option>
                    <option value="France">France</option>
                    <option value="Greece">Greece</option>
                    <option value="India">India</option>
                    <option value="Italy">Italy</option>
                    <option value="Japan">Japan</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Russia">Russia</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Spain">Spain</option>
                    <option value="Thailand">Thailand</option>
                    <option value="Turkey">Turkey</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="United States">United States</option>
                    <option value="Vietnam">Vietnam</option>
                </select>
            </div>

            <!-- Age input -->
            <div class="input-box">
                <input type="number" placeholder="Enter Age (Optional)" id="age" min="1" max="100" value="18">
            </div>

            <!-- Weather dropdown -->
            <div class="input-box">
                <label for="weather"></label>
                <select class="styled-input" id="weather" name="weather">
                    <option value="">Select Weather</option>
                    <option value="sunny">Sunny</option>
                    <option value="cloudy">Cloudy</option>
                    <option value="rainy">Rainy</option>
                    <option value="stormy">Stormy</option>
                    <option value="snowy">Snowy</option>
                    <option value="foggy">Foggy</option>
                    <option value="windy">Windy</option>
                </select>
            </div>

            <button onclick="searchRecommendations()">Search</button>
        </div>

        <!-- Font Awesome for the dropdown icon -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

        <div class="dropdown-container">
            <!-- Recommendation Logic Dropdown -->
            <div class="dropdown">
                <input type="checkbox" id="dropdown1">
                <label for="dropdown1" class="dropdown-button">
                    Recommendation Logic <i class="fas fa-chevron-down"></i>
                </label>
                <div class="dropdown-content">
                    <details open>
                        <summary><strong>üí° How Song Recommendations Work
                            </strong></summary>
                        <p>We use <strong>Singular Value Decomposition (SVD)</strong> to uncover deeper themes in both
                            user descriptions and song lyrics. SVD is a dimensionality reduction technique that breaks
                            down a large matrix (like a
                            bag-of-words model of lyrics) into a smaller set of <em>latent features</em>‚Äîabstract
                            "topics" that capture patterns in word usage. When a user describes what they‚Äôre feeling or
                            looking for, their input is vectorized and
                            projected into this reduced space. Then, we measure how close this projected vector is to
                            each song's topic vector. This gives us a <strong>topic match score</strong>, which reflects
                            the <em>thematic
                                similarity</em> between the user‚Äôs input and each song.</p>
                    </details>

                    <details>
                        <summary><strong>üß† How We Score Songs</strong></summary>
                        <p>Our recommendation system uses a <strong>multi-layered scoring system</strong> to rank songs:
                        </p>
                        <ul>
                            <li><strong>Topic Match Score (via SVD)</strong><br>
                                Measures how closely a song aligns with the user's input in terms of deeper themes.</li>
                            <li><strong>Word Match Score</strong><br>
                                Counts how many meaningful words from the user input appear in a song‚Äôs lyrics, using a
                                lemmatized, stopword-filtered comparison.</li>
                            <li><strong>Sentiment Match (Age + Weather-based)</strong><br>
                                Adjusts results based on how emotionally "bright" or "dark" the lyrics are, calibrated
                                to the user's age and (optionally) current weather sentiment.</li>
                            <li><strong>Antonym Penalty</strong><br>
                                Penalizes songs if they strongly feature antonyms of words the user used‚Äîhelping avoid
                                emotional or thematic mismatches.</li>
                        </ul>
                        <p>Each component contributes to a final <strong>combined score</strong>
                    </details>

                    <details>
                        <summary><strong>üåü Popularity (Optional Info)></strong></summary>
                        <p>Every song has a <strong>popularity score</strong> from 0 to 100, based on recent streaming
                            activity. This metric does <em>not</em> significantly affect recommendations, but helps
                            highlight currently trending songs on the platform.</p>
                    </details>
                </div>
            </div>

            <!-- Location Data Dropdown -->
            <div class="dropdown">
                <input type="checkbox" id="dropdown2">
                <label for="dropdown2" class="dropdown-button">
                    </h4>Location Vibes </h4><i class="fas fa-chevron-down"></i>
                </label>
                <div class="dropdown-content">
                    <p>We gathered location data from Google Maps, highlighting the top 5 places and the 3 best reviews
                        for each destination. This gives you a feel for the local vibe, not just through music, but also
                        through real-life experiences. Stay tuned for updates as we continue to enhance your
                        exploration. üåç‚ú®</p>
                </div>
            </div>
        </div>

        <div class="results-container">
            <div class="song-recommendations-box">
                <div id="loading-message-songs"></div>
                <div id="answer-box"></div>
            </div>
            <div id="location-info" class="location-info-box">
                <div class="location-header">
                    <div class="country-title">Select a country</div>
                    <div id="loading-message-locations">Loading locations...</div>
                </div>
                <div style="color: #666; font-style: italic;">
                    Choose a country from the dropdown to view top locations
                </div>
            </div>
        </div>
    </div>

    <script>
        // This will hold our country data
        let countryData = {};

        // Fetch the country data when the page loads
        window.addEventListener('DOMContentLoaded', (event) => {
            fetch('/static/countries_reviews.json')
                .then(response => response.json())
                .then(data => {
                    // Transform the data into a more usable format
                    countryData = data.reduce((acc, country) => {
                        const locations = [];
                        for (let i = 1; i <= 5; i++) {
                            locations.push({
                                name: country[`location_${i}`],
                                rating: country[`rating_${i}`],
                                num_reviews: country[`num_reviews_${i}`],
                                top_review: country[`top_review_${i}`]
                            });
                        }
                        acc[country.country] = { locations };
                        return acc;
                    }, {});
                })
                .catch(error => {
                    console.error('Error loading country data:', error);
                });
        });

        function searchRecommendations() {
            console.log("Function searchRecommendations() was called!");
            const mood = document.getElementById("mood").value;
            const country = document.getElementById("country").value;
            const age = document.getElementById("age").value;
            const weather = document.getElementById("weather").value;

            console.log("Search initiated with parameters:", { mood, country, age, weather });

            const answerBox = document.getElementById("answer-box");
            answerBox.innerHTML = "";

            const loadingMessageSongs = document.getElementById("loading-message-songs");
            const loadingMessageLocations = document.getElementById("loading-message-locations");

            loadingMessageSongs.style.display = "none";
            loadingMessageLocations.style.display = "none";
            loadingMessageSongs.textContent = "Loading song recommendations...";

            if (!mood) {
                alert("Please provide a mood description.");
                console.log("Input validation failed: Mood is missing.");
                return;
            }

            // Display location info if country is selected
            const locationInfoBox = document.getElementById("location-info");

            if (country && countryData[country]) {
                const countryInfo = countryData[country];
                let locationHTML = `
                    <div class="location-header">
                        <div class="country-title">Top Locations in ${country}</div>
                        <div id="loading-message-locations">Loading locations...</div>
                    </div>
                `;

                countryInfo.locations.forEach(location => {
                    locationHTML += `
                        <div class="location-item">
                            <div class="location-name">${location.name}</div>
                            <div>
                                <span class="location-rating">‚òÖ ${location.rating}</span>
                                <span class="location-reviews">${location.num_reviews} reviews</span>
                            </div>
                            <div class="location-review">"${location.top_review}"</div>
                        </div>
                    `;
                });

                locationInfoBox.innerHTML = locationHTML;
                loadingMessageLocations.style.display = "block";
            } else if (country) {
                locationInfoBox.innerHTML = `
                    <div class="location-header">
                        <div class="country-title">No data available</div>
                        <div id="loading-message-locations">Loading locations...</div>
                    </div>
                    <div style="color: #666;">No location information found for ${country}</div>
                `;
                loadingMessageLocations.style.display = "block";
            } else {
                locationInfoBox.innerHTML = `
                    <div class="location-header">
                        <div class="country-title">No country selected</div>
                        <div id="loading-message-locations">Loading locations...</div>
                    </div>
                    <div style="color: #666; font-style: italic;">
                        Select a country to see popular locations
                    </div>
                `;
                loadingMessageLocations.style.display = "none";
            }

            loadingMessageSongs.style.display = "block";

            const requestUrl = "/recommendations?" + new URLSearchParams({
                mood: mood,
                country: country,
                age: age,
                weather: weather
            }).toString();

            console.log("Fetching recommendations from:", requestUrl);

            fetch(requestUrl)
                .then(response => {
                    console.log("Response received:", response);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Parsed response data:", data);
                    loadingMessageSongs.style.display = "none";
                    loadingMessageLocations.style.display = "none";

                    if (data && data.length > 0) {
                        data.forEach(song => {
                            let songDiv = document.createElement("div");
                            songDiv.classList.add("song-box");
                            songDiv.innerHTML = `
                                    <div class="song-container">
                                        <div class="song-image">
                                            <img src="${song.image_url}" alt="${song.title} album cover" class="album-cover">
                                        </div>
                                        <div class="song-details">
                                            <h3 class="song-title">${song.title}</h3>
                                            <p class="song-artist">by ${song.artist}</p>
                                            <p class="song-rating">Rating: ${song.rating ? song.rating.toFixed(2) : 'Not available'}</p>
                                            <p class="song-popularity">Popularity Score: ${song.popularity}</p>
                                            <a href="${song.song_url}" target="_blank" class="play-button">Play on Spotify</a>
                                        </div>
                                    </div>
                                `;
                            answerBox.appendChild(songDiv);
                        });
                    } else {
                        console.log("No songs found.");
                        answerBox.innerHTML = "<p>No songs found matching your mood.</p>";
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    loadingMessageSongs.style.display = "none";
                    loadingMessageLocations.style.display = "none";
                    answerBox.innerHTML = "<p>No songs found matching your mood.</p>";
                });
        }
    </script>
</body>